<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Mobile Store</title>
    <link rel="icon" type="image/png" href="images/iconlogo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .top-banner {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            padding: 10px 0;
            text-align: center;
            font-size: 13px;
            color: white;
            font-weight: 500;
        }

        .main-header {
            padding: 20px 5%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 12px;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .logo span {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            letter-spacing: -0.5px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .back-btn {
            padding: 10px 20px;
            background: #f3f4f6;
            color: #1f2937;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transform: translateY(-1px);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Navigation Cards */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .nav-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(37, 99, 235, 0.15);
            border-color: #2563eb;
        }

        .nav-card-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .nav-card-icon svg {
            width: 32px;
            height: 32px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        .nav-card-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .nav-card-desc {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #1f2937;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            border-color: #2563eb;
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .card-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .badge-processing {
            background: #dbeafe;
            color: #2563eb;
        }

        .badge-completed {
            background: #d1fae5;
            color: #059669;
        }

        .badge-delivered {
            background: #d1fae5;
            color: #059669;
        }

        .badge-shipped {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-out-for-delivery {
            background: #e0e7ff;
            color: #6366f1;
        }

        /* Status Dropdown */
        .status-dropdown {
            position: absolute;
            top: 100%;
            bottom: auto;
            right: 0;
            margin-top: 8px;
            margin-bottom: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            /* Stronger shadow on card text below */
            z-index: 1000;
            min-width: 160px;
            display: none;
            overflow: hidden;
        }

        .status-dropdown.active {
            display: block;
        }

        .status-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-option:hover {
            background: #f3f4f6;
        }

        .status-option.selected {
            background: #eff6ff;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.processing {
            background: #2563eb;
        }

        .status-dot.shipped {
            background: #d97706;
        }

        .status-dot.out-for-delivery {
            background: #6366f1;
        }

        .status-dot.delivered {
            background: #059669;
        }

        .card-info {
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-label {
            color: #6b7280;
        }

        .info-value {
            color: #1f2937;
            font-weight: 600;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid #e5e7eb;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            flex: 1;
        }

        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .btn-success {
            background: #d1fae5;
            color: #059669;
        }

        .btn-success:hover {
            background: #a7f3d0;
        }

        /* Checkbox for Bulk Delete */
        .card-checkbox {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 24px;
            height: 24px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: white;
            z-index: 10;
        }

        .card-checkbox.active {
            display: flex;
        }

        .card-checkbox.selected {
            background: #2563eb;
            border-color: #2563eb;
        }

        .card-checkbox svg {
            width: 16px;
            height: 16px;
            stroke: white;
            fill: none;
            stroke-width: 3;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .card-checkbox.selected svg {
            opacity: 1;
        }

        /* Shift badge left when checkbox is active */
        .card-checkbox.active~.card-header .card-badge {
            margin-right: 35px;
            transition: margin-right 0.3s ease;
        }

        /* Floating Delete Button (Confirm - Checkmark) */
        .floating-delete-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #dc2626;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .floating-delete-btn:hover {
            transform: scale(1.1);
        }

        .floating-delete-btn svg {
            width: 24px;
            height: 24px;
            stroke: white;
            fill: none;
            stroke-width: 2.5;
        }

        /* Delete Mode Toggle Button */
        .delete-mode-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 10px 20px;
            border-radius: 25px;
            background: #dc2626;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            z-index: 99;
        }

        .delete-mode-toggle svg {
            width: 18px;
            height: 18px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        .delete-mode-toggle:hover {
            transform: translateY(-2px);
        }

        /* Active state - becomes circular with checkmark */
        .delete-mode-toggle.active-mode {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            background: #dc2626;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-mode-toggle.active-mode svg {
            width: 24px;
            height: 24px;
        }

        /* RTL Support for Delete Mode Toggle */
        body.rtl .delete-mode-toggle {
            right: auto;
            left: 30px;
        }

        body.rtl .floating-delete-btn {
            right: auto;
            left: 30px;
        }

        body.rtl .cancel-delete-btn {
            right: auto;
            left: 35px;
        }

        /* Admin Login Modal */
        #adminLoginModal {
            display: none;
            background: #f8f9fa;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            /* Ensure it's on top */
        }

        #adminLoginModal.active {
            display: flex;
        }

        .login-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
        }

        .login-header img {
            height: 50px;
            width: auto;
        }

        .login-content {
            max-width: 400px;
            width: 90%;
            text-align: center;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-top: 80px;
            background: white;
        }

        /* Phone number fix for RTL */
        .phone-number {
            direction: ltr !important;
            unicode-bidi: embed;
        }

        /* Align phone numbers to the right in RTL mode to match headers */
        body.rtl .phone-number {
            text-align: right !important;
        }

        /* Cancel Button (X) - appears above confirm */
        .cancel-delete-btn {
            position: fixed;
            bottom: 90px;
            right: 35px;
            /* Centered above confirm button */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6b7280;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 101;
        }

        .cancel-delete-btn:hover {
            transform: scale(1.1);
            background: #9ca3af;
        }

        .cancel-delete-btn svg {
            width: 20px;
            height: 20px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #6b7280;
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 400px;
            /* Force some vertical space */
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            stroke: #9ca3af;
            fill: none;
            stroke-width: 2;
        }

        /* Invalid Field Styling */
        .invalid-field {
            border: 2px solid #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .invalid-field:focus {
            border: 2px solid #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Details List */
        .details-list {
            margin-top: 20px;
        }

        .details-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }

        .details-item h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .details-item p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        /* Confirmation Modal */
        .confirm-modal-content {
            max-width: 450px;
            text-align: center;
            padding: 40px;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal.active .confirm-modal-content {
            transform: scale(1);
        }

        .confirm-modal-icon {
            width: 80px;
            height: 80px;
            background: #fee2e2;
            color: #dc2626;
            margin: 0 auto 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(220, 38, 38, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
            }
        }

        .confirm-modal-icon.warning {
            background: #fef3c7;
            color: #d97706;
            animation: pulse-amber 2s infinite;
        }

        @keyframes pulse-amber {
            0% {
                box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(217, 119, 6, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(217, 119, 6, 0);
            }
        }

        .confirm-modal-icon svg {
            width: 40px;
            height: 40px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2.5;
        }

        .confirm-modal-title {
            font-size: 24px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .confirm-modal-message {
            font-size: 16px;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 35px;
        }

        .confirm-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .confirm-actions .btn {
            padding: 16px;
            font-size: 15px;
            font-weight: 700;
            justify-content: center;
            border-radius: 12px;
        }

        body.rtl .confirm-actions {
            direction: rtl;
        }
    </style>
    <style>
        /* RTL Support */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

        body.rtl {
            direction: rtl;
            font-family: 'Cairo', sans-serif;
        }

        body.rtl .back-btn svg {
            transform: scaleX(-1);
        }

        body.rtl .header-title {
            margin-left: 0;
            margin-right: 20px;
        }

        body.rtl th {
            text-align: right !important;
        }

        body.rtl .nav-card-icon {
            margin-right: 0;
            margin-left: auto;
        }

        body.rtl .nav-card-title,
        body.rtl .nav-card-desc {
            text-align: right;
        }

        body.rtl .card-badge {
            margin-right: 0;
            margin-left: 10px;
        }

        /* Align dropdown to the left (start) of the badge in RTL so it grows inwards */
        body.rtl .status-dropdown {
            right: auto;
            left: 0;
        }

        body.rtl .form-group label {
            text-align: right;
        }

        body.rtl .modal-title {
            text-align: right;
        }

        body.rtl .btn {
            flex-direction: row-reverse;
        }

        body.rtl .close-modal-btn {
            right: auto;
            left: 20px;
        }
    </style>
    <style>
        /* Customer Details Modal Styling */
        .customer-profile-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .detail-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .detail-card:hover {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: #d1d5db;
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .detail-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon.contact {
            background: #dbeafe;
            color: #2563eb;
        }

        .header-icon.orders {
            background: #fef3c7;
            color: #d97706;
        }

        .header-icon.location {
            background: #d1fae5;
            color: #059669;
        }

        .header-icon svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-item .label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .info-item .value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
        }

        .info-item .value.highlight {
            color: #2563eb;
            font-size: 16px;
        }

        /* Order List Styling */
        .orders-list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 5px;
            /* Scrollbar space */
        }

        .order-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .order-main {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .order-id {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
        }

        .order-date {
            font-size: 12px;
            color: #6b7280;
        }

        .order-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .order-total {
            font-weight: 700;
            color: #2563eb;
            font-size: 14px;
        }

        .status-badge-small {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        /* Address Box */
        .addresses-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
        }

        .address-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .address-icon {
            width: 32px;
            height: 32px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: #4b5563;
        }

        .address-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .address-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .addr-line {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
        }

        .addr-city {
            font-size: 12px;
            color: #6b7280;
        }

        .addr-phone {
            font-size: 12px;
            color: #2563eb;
            margin-top: 4px;
            font-weight: 500;
        }

        .empty-state-small {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
            font-size: 13px;
            font-style: italic;
        }

        /* RTL Adjustments for Modal */
        body.rtl .detail-header {
            flex-direction: row;
        }

        body.rtl .order-meta {
            align-items: flex-start;
            /* Because order-meta is naturally right-aligned in LTR, in RTL we want it on the Left? NO. justify-content: space-between puts meta on LEFT in RTL. So align-items should be correct context. */
            /* In RTL flex row: Start is Right, End is Left. */
            /* order-list-item: space-between. Main (Right), Meta (Left). */
            /* Meta column items should align to Left (End of container)? Or Start (Right)? */
            /* Usually we want text aligned to the edge. Meta is on Left edge. So align-items: flex-end (Left in RTL? No, flex-end is Left in RTL row? No. flex-end is End of cross axis? No column axis.) */
            /* Meta is flex-direction: column. align-items defaults to stretch. We want it aligned to the 'end' relative to the item? */
            /* align-items: flex-end aligns to Right in LTR. In RTL? */
            /* Let's test. */
            align-items: flex-end;
            /* Keep it flex-end if we want it aligned to the logical end */
        }

        body.rtl .order-id,
        body.rtl .order-date {
            text-align: right;
        }

        body.rtl .order-total,
        body.rtl .status-badge-small {
            text-align: left;
            /* Meta textual alignment */
        }
    </style>

<body>
    <!-- Header -->
    <div class="header">
        <div class="top-banner" data-i18n="admin-title">
            Admin Dashboard - Manage Your Mobile Store
        </div>
        <div class="main-header">
            <div class="logo" onclick="window.location.href='index.html'">
                <img src="images/mobile-logo.png" alt="Mobile Store Logo">
                <span data-i18n="nav-brand-text">Mobile Store</span>
            </div>
            <!-- Removed Dashboard title as requested -->
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="back-btn" onclick="window.location.href='index.html'" data-i18n="admin-back">
                    العودة للمتجر
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Home View -->
        <div id="homeView" class="content-section active">
            <div class="section-header">
                <h1 class="section-title" data-i18n="admin-dashboard">Dashboard</h1>
            </div>

            <div class="nav-grid">
                <!-- Main Dashboard Card -->
                <div class="nav-card" onclick="showSection('dashboard')">
                    <div class="nav-card-icon">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                        </svg>
                    </div>
                    <h2 class="nav-card-title" data-i18n="admin-main-dashboard">Main Dashboard</h2>
                    <p class="nav-card-desc" data-i18n="admin-main-desc">Complete database control, statistics, and
                        advanced management tools</p>
                </div>

                <!-- Orders Card -->
                <div class="nav-card" onclick="showSection('orders')">
                    <div class="nav-card-icon">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                        </svg>
                    </div>
                    <h2 class="nav-card-title" data-i18n="admin-orders">Orders</h2>
                    <p class="nav-card-desc" data-i18n="admin-orders-desc">View and manage all customer orders, track
                        status, and process receipts</p>
                </div>

                <!-- Accounts Card -->
                <div class="nav-card" onclick="showSection('accounts')">
                    <div class="nav-card-icon">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                        </svg>
                    </div>
                    <h2 class="nav-card-title" data-i18n="admin-accounts">Accounts</h2>
                    <p class="nav-card-desc" data-i18n="admin-accounts-desc">Manage customer accounts, add new users,
                        and view account details</p>
                </div>
            </div>
        </div>

        <!-- Orders View -->
        <div id="ordersView" class="content-section">
            <div class="section-header">
                <h1 class="section-title" data-i18n="orders-title">Customer Orders</h1>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="showCreateOrderModal()">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        <span data-i18n="orders-create-btn">Create Order</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('home')" data-i18n="admin-btn-back">
                        Back
                    </button>
                </div>
            </div>
            <div id="ordersGrid" class="cards-grid"></div>

            <!-- Delete Mode Toggle / Confirm Button -->
            <button id="deleteOrdersModeBtn" class="delete-mode-toggle" onclick="toggleOrdersDeleteMode()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
                <span data-i18n="orders-delete-btn">Delete Orders</span>
            </button>

            <!-- Cancel Button (Hidden by default) -->
            <button id="cancelOrdersDeleteBtn" class="cancel-delete-btn" onclick="toggleOrdersDeleteMode()">
                <svg viewBox="0 0 24 24">
                    <path d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Accounts View -->
        <div id="accountsView" class="content-section">
            <div class="section-header">
                <h1 class="section-title" data-i18n="admin-customer-accounts">Customer Accounts</h1>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="showAddCustomerModal()">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        <span data-i18n="admin-add-customer">Add Customer</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('home')" data-i18n="admin-btn-back">
                        Back
                    </button>
                </div>
            </div>
            <div id="accountsGrid" class="cards-grid"></div>

            <!-- Delete Mode Toggle / Confirm Button -->
            <button id="deleteModeBtn" class="delete-mode-toggle" onclick="toggleDeleteMode()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
                <span data-i18n="accounts-delete-btn">Delete Accounts</span>
            </button>

            <!-- Cancel Button (Hidden by default) -->
            <button id="cancelDeleteBtn" class="cancel-delete-btn" onclick="toggleDeleteMode()">
                <svg viewBox="0 0 24 24">
                    <path d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Main Dashboard View -->
        <div id="dashboardView" class="content-section">
            <div class="section-header">
                <h1 class="section-title" data-i18n="admin-main-dashboard">Main Dashboard</h1>
                <button class="btn btn-secondary" onclick="showSection('home')" data-i18n="admin-btn-back">
                    ← Back
                </button>
            </div>

            <!-- Enhanced Stats -->
            <div class="nav-grid" style="margin-bottom: 30px;">
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 8px;"
                                data-i18n="dash-total-orders">Total Orders
                            </h3>
                            <p style="font-size: 32px; font-weight: 700; color: white;" id="totalOrders">0</p>
                        </div>
                        <svg style="width: 40px; height: 40px; opacity: 0.3;" viewBox="0 0 24 24" fill="white">
                            <path
                                d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                        </svg>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 8px;"
                                data-i18n="dash-total-customers">Total
                                Customers</h3>
                            <p style="font-size: 32px; font-weight: 700; color: white;" id="totalCustomers">0</p>
                        </div>
                        <svg style="width: 40px; height: 40px; opacity: 0.3;" viewBox="0 0 24 24" fill="white">
                            <path
                                d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                        </svg>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 8px;"
                                data-i18n="dash-total-revenue">Total Revenue
                            </h3>
                            <p style="font-size: 32px; font-weight: 700; color: white;" id="totalRevenue">0 EGP</p>
                        </div>
                        <svg style="width: 40px; height: 40px; opacity: 0.3;" viewBox="0 0 24 24" fill="white">
                            <path
                                d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div class="card">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;" data-i18n="dash-revenue-trend">
                        Revenue Trend (Last 7 Days)</h3>
                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="card">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;" data-i18n="dash-order-status">
                        Order Status</h3>
                    <canvas id="orderStatusChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div class="card">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;" data-i18n="dash-recent-orders">
                        Recent Orders</h3>
                    <div id="recentOrders"></div>
                </div>
                <div class="card">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;"
                        data-i18n="dash-recent-customers">Recent Customers</h3>
                    <div id="recentCustomers"></div>
                </div>
            </div>

            <!-- Data Tables -->
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;" data-i18n="dash-all-data">All Data</h2>
            <div id="dashboardContent"></div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <h2 class="modal-title" data-i18n="modal-add-customer-title">Add New Customer</h2>
            <form id="addCustomerForm">
                <div class="form-group">
                    <label data-i18n="label-fullname">Full Name</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label data-i18n="label-email">Email</label>
                    <input type="email" id="customerEmail" required>
                </div>
                <div class="form-group">
                    <label data-i18n="label-password">Password</label>
                    <input type="password" id="customerPassword" required>
                </div>
                <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddCustomerModal()"
                        style="flex: 1; padding: 12px; border-radius: 8px; display: flex; align-items: center; justify-content: center;"
                        data-i18n="btn-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary"
                        style="flex: 1; padding: 12px; border-radius: 8px; display: flex; align-items: center; justify-content: center;"
                        data-i18n="btn-add">Add Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal" id="customerDetailsModal">
        <div class="modal-content" style="position: relative;">
            <button class="close-modal-btn" onclick="closeDetailsModal()">
                <svg viewBox="0 0 24 24">
                    <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </button>
            </button>
            <h2 class="modal-title" id="detailsName" data-i18n="modal-details-title">Customer Details</h2>
            <div id="detailsContent"></div>
        </div>
    </div>

    <style>
        .close-modal-btn {
            position: absolute;
            top: 24px;
            /* Aligned with title */
            right: 32px;
            /* Aligned with padding */
            background: none;
            border: none;
            cursor: pointer;
            color: #9ca3af;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal-btn:hover {
            background: #f3f4f6;
            color: #ef4444;
            /* Red on hover */
        }

        .close-modal-btn svg {
            width: 24px;
            height: 24px;
        }
    </style>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script src="JS/db.js"></script>
    <script>
        let currentSection = 'home';
        let isDeleteMode = false;
        let selectedCustomers = new Set();
        let isOrdersDeleteMode = false;
        let selectedOrders = new Set();

        // Wait for database
        window.addEventListener('localDBReady', () => {
            loadAllData();
        });

        // Show Section
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            // Reset delete modes
            if (isDeleteMode) toggleDeleteMode();
            if (isOrdersDeleteMode) toggleOrdersDeleteMode();

            // Show selected section
            if (section === 'home') {
                document.getElementById('homeView').classList.add('active');
            } else if (section === 'orders') {
                document.getElementById('ordersView').classList.add('active');
                loadOrders();
            } else if (section === 'accounts') {
                document.getElementById('accountsView').classList.add('active');
                loadAccounts();
            } else if (section === 'dashboard') {
                document.getElementById('dashboardView').classList.add('active');
                loadDashboard();
            }

            currentSection = section;
        }

        // Load All Data
        async function loadAllData() {
            try {
                const orders = await window.localDB.getAllData('orders');
                const users = await window.localDB.getAllData('users');

                document.getElementById('totalOrders').textContent = orders.length;
                document.getElementById('totalCustomers').textContent = users.length;

                const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                const currency = currentLang === 'ar' ? 'ج.م' : 'EGP';
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' ' + currency;
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Load Orders
        async function loadOrders() {
            try {
                const orders = await window.localDB.getAllData('orders');
                const users = await window.localDB.getAllData('users');
                const grid = document.getElementById('ordersGrid');

                if (orders.length === 0) {
                    grid.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/></svg><p>${translations[currentLang]['orders-empty']}</p></div>`;
                    return;
                }

                grid.innerHTML = orders.map(order => {
                    const user = users.find(u => u.id === order.userId);
                    const customerName = order.shipping ? `${order.shipping.firstName} ${order.shipping.lastName}` : (user?.name || 'Unknown');
                    const date = new Date(order.date || order.orderDate).toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Get shipping address
                    const shippingAddress = order.shipping ?
                        `${order.shipping.address}, ${order.shipping.city}, ${order.shipping.governorate}` :
                        (order.address ? `${order.address}, ${order.city || ''}` : 'No address');

                    const phone = order.shipping?.phone || order.phone || 'N/A';

                    // Get item names
                    const itemsList = order.items && order.items.length > 0 ?
                        order.items.map(item => `${item.name} (x${item.quantity})`).join(', ') :
                        'No items';

                    // Normalize status for CSS class
                    const statusClass = (order.status || 'Processing').toLowerCase().replace(/\s+/g, '-');
                    const statusKey = `status-${statusClass.replace(/-+/g, '-')}`;
                    // Fallback to order.status if key doesn't exist, but it should
                    const displayStatus = translations[currentLang][statusKey] || order.status || 'Processing';

                    return `
                        <div class="card" onclick="toggleOrderSelection('${order.id}')">
                            <div class="card-checkbox ${selectedOrders.has(order.id) ? 'selected' : ''} ${isOrdersDeleteMode ? 'active' : ''}" id="order-check-${order.id}">
                                <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                            <div class="card-header">
                                <div class="card-title">#${order.orderNumber}</div>
                                <div style="position: relative;">
                                    <span class="card-badge badge-${statusClass}" onclick="event.stopPropagation(); toggleStatusDropdown('${order.id}')">${displayStatus}</span>
                                    <div class="status-dropdown" id="status-dropdown-${order.id}">
                                        <div class="status-option ${order.status === 'Processing' ? 'selected' : ''}" onclick="event.stopPropagation(); changeOrderStatus('${order.id}', 'Processing')">
                                            <span class="status-dot processing"></span>
                                            ${translations[currentLang]['status-processing']}
                                        </div>
                                        <div class="status-option ${order.status === 'Shipped' ? 'selected' : ''}" onclick="event.stopPropagation(); changeOrderStatus('${order.id}', 'Shipped')">
                                            <span class="status-dot shipped"></span>
                                            ${translations[currentLang]['status-shipped']}
                                        </div>
                                        <div class="status-option ${order.status === 'Out for Delivery' ? 'selected' : ''}" onclick="event.stopPropagation(); changeOrderStatus('${order.id}', 'Out for Delivery')">
                                            <span class="status-dot out-for-delivery"></span>
                                            ${translations[currentLang]['status-out-for-delivery']}
                                        </div>
                                        <div class="status-option ${order.status === 'Delivered' ? 'selected' : ''}" onclick="event.stopPropagation(); changeOrderStatus('${order.id}', 'Delivered')">
                                            <span class="status-dot delivered"></span>
                                            ${translations[currentLang]['status-delivered']}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-info">
                                <div class="info-row">
                                    <span class="info-label">${translations[currentLang]['label-customer']}</span>
                                    <span class="info-value">${customerName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">${translations[currentLang]['label-date']}</span>
                                    <span class="info-value">${date}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">${translations[currentLang]['label-phone']}</span>
                                    <span class="info-value phone-number">${phone}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">${translations[currentLang]['label-address']}</span>
                                    <span class="info-value" style="font-size: 13px;">${shippingAddress}</span>
                                </div>
                                <div class="info-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <span class="info-label">${translations[currentLang]['label-items']}</span>
                                    <span class="info-value">${order.items?.length || 0}</span>
                                </div>
                                <div class="info-row" style="margin-top: 8px;">
                                    <span class="info-label" style="align-self: flex-start;">${translations[currentLang]['label-products']}</span>
                                    <span class="info-value" style="font-size: 13px; text-align: right; max-width: 70%;">${itemsList}</span>
                                </div>
                                <div class="info-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <span class="info-label">${translations[currentLang]['label-total']}</span>
                                    <span class="info-value" style="color: #2563eb; font-size: 16px;">${(order.total || 0).toLocaleString()} ${currentLang === 'ar' ? 'ج.م' : 'EGP'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Toggle Status Dropdown
        function toggleStatusDropdown(orderId) {
            const dropdown = document.getElementById(`status-dropdown-${orderId}`);

            // Close all other dropdowns
            document.querySelectorAll('.status-dropdown').forEach(d => {
                if (d.id !== `status-dropdown-${orderId}`) {
                    d.classList.remove('active');
                }
            });

            // Toggle current dropdown
            dropdown.classList.toggle('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.card-badge') && !event.target.closest('.status-dropdown')) {
                document.querySelectorAll('.status-dropdown').forEach(d => {
                    d.classList.remove('active');
                });
            }
        });

        // Change Order Status
        async function changeOrderStatus(orderId, newStatus) {
            try {
                // Convert to number for IndexedDB
                const id = Number(orderId);
                const order = await window.localDB.getData('orders', id);

                if (!order) {
                    alert('Order not found');
                    return;
                }

                // Update status
                order.status = newStatus;

                // Update in database
                await window.localDB.updateData('orders', order);

                // Close dropdown
                document.getElementById(`status-dropdown-${orderId}`).classList.remove('active');

                // Reload orders to show updated status
                loadOrders();
                loadAllData();
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Error updating order status');
            }
        }

        // Toggle Orders Delete Mode
        function toggleOrdersDeleteMode() {
            const deleteBtn = document.getElementById('deleteOrdersModeBtn');
            const cancelBtn = document.getElementById('cancelOrdersDeleteBtn');

            if (!isOrdersDeleteMode) {
                // Entering delete mode
                isOrdersDeleteMode = true;
                selectedOrders.clear();

                // Show checkboxes
                const checkboxes = document.querySelectorAll('.card-checkbox');
                checkboxes.forEach(cb => {
                    cb.classList.add('active');
                    cb.classList.remove('selected');
                });

                // Transform delete button to checkmark (confirm)
                deleteBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                deleteBtn.classList.add('active-mode');
                deleteBtn.onclick = confirmOrdersDelete;

                // Show cancel button
                cancelBtn.style.display = 'flex';
            } else {
                // Exiting delete mode
                isOrdersDeleteMode = false;
                selectedOrders.clear();

                // Hide checkboxes
                const checkboxes = document.querySelectorAll('.card-checkbox');
                checkboxes.forEach(cb => {
                    cb.classList.remove('active', 'selected');
                });

                // Restore delete button
                deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> <span data-i18n="orders-delete-btn">${translations[currentLang]['orders-delete-btn']}</span>`;
                deleteBtn.classList.remove('active-mode');
                deleteBtn.onclick = toggleOrdersDeleteMode;

                // Hide cancel button
                cancelBtn.style.display = 'none';
            }
        }

        // Confirm Delete Orders (called when checkmark is clicked)
        function confirmOrdersDelete() {
            if (selectedOrders.size === 0) {
                alert('Please select at least one order to delete.');
                return;
            }

            deleteSelectedOrders();
        }

        // Toggle Order Selection
        function toggleOrderSelection(orderId) {
            if (!isOrdersDeleteMode) return;

            // Convert to number for IndexedDB
            const id = Number(orderId);
            const checkbox = document.getElementById(`order-check-${id}`);

            if (selectedOrders.has(id)) {
                selectedOrders.delete(id);
                checkbox.classList.remove('selected');
            } else {
                selectedOrders.add(id);
                checkbox.classList.add('selected');
            }
        }

        // Delete Selected Orders
        async function deleteSelectedOrders() {
            if (selectedOrders.size === 0) {
                alert('Please select at least one order to delete.');
                return;
            }

            const confirmTitle = translations[currentLang]['orders-confirm-delete'] || (currentLang === 'ar' ? 'تأكيد الحذف' : 'Confirm Delete');
            const confirmMsg = currentLang === 'ar'
                ? `هل أنت متأكد أنك تريد حذف ${selectedOrders.size} من الطلبات المختارة؟`
                : `Are you sure you want to delete ${selectedOrders.size} selected order(s)?`;

            if (await showConfirm(confirmTitle, confirmMsg)) {
                try {
                    for (const orderId of selectedOrders) {
                        await window.localDB.deleteData('orders', orderId);
                    }

                    toggleOrdersDeleteMode();
                    loadOrders();
                    loadAllData();
                    alert('Selected orders deleted successfully!');
                } catch (error) {
                    console.error('Error deleting orders:', error);
                    alert('Error deleting orders');
                }
            }
        }

        // Load Accounts
        async function loadAccounts() {
            try {
                const users = await window.localDB.getAllData('users');
                const grid = document.getElementById('accountsGrid');

                if (users.length === 0) {
                    grid.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/></svg><p>${translations[currentLang]['admin-no-customers']}</p></div>`;
                    return;
                }

                grid.innerHTML = users.map(user => {
                    const date = new Date(user.createdAt).toLocaleDateString();

                    return `
                        <div class="card" onclick="toggleSelection('${user.id}')">
                            <div class="card-checkbox ${selectedCustomers.has(user.id) ? 'selected' : ''} ${isDeleteMode ? 'active' : ''}" id="check-${user.id}">
                                <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                            <div class="card-header">
                                <div class="card-title">${user.name}</div>
                            </div>
                            <div class="card-info">
                                <div class="info-row">
                                    <span class="info-label">${translations[currentLang]['label-email']}</span>
                                    <span class="info-value">${user.email}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">${translations[currentLang]['label-registered']}</span>
                                    <span class="info-value">${date}</span>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); showCustomerDetails('${user.id}')">
                                    <svg viewBox="0 0 24 24"><path d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>
                                    ${translations[currentLang]['btn-details']}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        // Toggle Delete Mode
        function toggleDeleteMode() {
            const deleteBtn = document.getElementById('deleteModeBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');

            if (!isDeleteMode) {
                // Entering delete mode
                isDeleteMode = true;
                selectedCustomers.clear();

                // Show checkboxes
                const checkboxes = document.querySelectorAll('.card-checkbox');
                checkboxes.forEach(cb => {
                    cb.classList.add('active');
                    cb.classList.remove('selected');
                });

                // Transform delete button to checkmark (confirm)
                deleteBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                deleteBtn.classList.add('active-mode');
                deleteBtn.onclick = confirmDelete;

                // Show cancel button
                cancelBtn.style.display = 'flex';
            } else {
                // Exiting delete mode
                isDeleteMode = false;
                selectedCustomers.clear();

                // Hide checkboxes
                const checkboxes = document.querySelectorAll('.card-checkbox');
                checkboxes.forEach(cb => {
                    cb.classList.remove('active', 'selected');
                });

                // Restore delete button
                deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> <span data-i18n="accounts-delete-btn">${translations[currentLang]['accounts-delete-btn']}</span>`;
                deleteBtn.classList.remove('active-mode');
                deleteBtn.onclick = toggleDeleteMode;

                // Hide cancel button
                cancelBtn.style.display = 'none';
            }
        }

        // Confirm Delete (called when checkmark is clicked)
        function confirmDelete() {
            if (selectedCustomers.size === 0) {
                alert('Please select at least one customer to delete.');
                return;
            }

            deleteSelectedCustomers();
        }

        // Toggle Selection
        function toggleSelection(userId) {
            if (!isDeleteMode) return;

            // Convert to number for IndexedDB
            const id = Number(userId);
            const checkbox = document.getElementById(`check-${id}`);

            if (selectedCustomers.has(id)) {
                selectedCustomers.delete(id);
                checkbox.classList.remove('selected');
            } else {
                selectedCustomers.add(id);
                checkbox.classList.add('selected');
            }
        }

        // Delete Selected Customers
        async function deleteSelectedCustomers() {
            if (selectedCustomers.size === 0) {
                alert('Please select at least one customer to delete.');
                return;
            }

            const confirmTitle = translations[currentLang]['accounts-confirm-delete'] || (currentLang === 'ar' ? 'تأكيد الحذف' : 'Confirm Delete');
            const confirmMsg = currentLang === 'ar'
                ? `هل أنت متأكد أنك تريد حذف ${selectedCustomers.size} من العملاء المختارين؟ سيتم أيضاً حذف جميع طلباتهم وعناوينهم.`
                : `Are you sure you want to delete ${selectedCustomers.size} customer(s)? This will also delete their orders and addresses.`;

            if (await showConfirm(confirmTitle, confirmMsg)) {
                try {
                    const orders = await window.localDB.getAllData('orders');
                    const addresses = await window.localDB.getAllData('addresses');

                    for (const userId of selectedCustomers) {
                        await window.localDB.deleteData('users', userId);

                        // Delete related data
                        for (const order of orders.filter(o => o.userId === userId)) {
                            await window.localDB.deleteData('orders', order.id);
                        }
                        for (const addr of addresses.filter(a => a.userId === userId)) {
                            await window.localDB.deleteData('addresses', addr.id);
                        }
                    }

                    toggleDeleteMode();
                    loadAccounts();
                    loadAllData();
                    alert('Selected customers deleted successfully!');
                } catch (error) {
                    console.error('Error deleting customers:', error);
                    alert('Error deleting customers');
                }
            }
        }

        // Show Customer Details
        async function showCustomerDetails(userId) {
            try {
                // Convert to number for IndexedDB
                const id = Number(userId);
                const user = await window.localDB.getData('users', id);

                if (!user) {
                    console.error('User not found:', id);
                    alert('User details not found');
                    return;
                }

                const orders = await window.localDB.getAllData('orders');
                const addresses = await window.localDB.getAllData('addresses');

                const userOrders = orders.filter(o => o.userId === id);
                const userAddresses = addresses.filter(a => a.userId === id);

                const content = document.getElementById('detailsContent');
                document.getElementById('detailsName').textContent = user.name;

                // Calculate extra stats
                const totalSpent = userOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'N/A';
                // Find primary phone from addresses
                const primaryPhone = userAddresses.length > 0 ? userAddresses[0].phone : 'N/A';

                let html = `
                    <div class="customer-profile-grid">
                        <!-- Contact Info Card -->
                        <div class="detail-card">
                            <div class="detail-header">
                                <div class="header-icon contact">
                                    <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                </div>
                                <h3>${translations[currentLang]['modal-contact-info']}</h3>
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label">${translations[currentLang]['label-email']}</span>
                                    <span class="value">${user.email}</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">${translations[currentLang]['th-phone']}</span>
                                    <span class="value phone-number">${primaryPhone}</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">${translations[currentLang]['label-joined']}</span>
                                    <span class="value">${new Date(user.createdAt).toLocaleDateString()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">${translations[currentLang]['dash-total-revenue']}</span>
                                    <span class="value highlight">${totalSpent.toLocaleString()} ${currentLang === 'ar' ? 'ج.م' : 'EGP'}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Orders Card -->
                        <div class="detail-card">
                            <div class="detail-header">
                                <div class="header-icon orders">
                                    <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                                </div>
                                <h3>${translations[currentLang]['modal-customer-orders']} (${userOrders.length})</h3>
                            </div>
                            <div class="orders-list-container">
                                ${userOrders.length > 0 ? userOrders.map(o => {
                    const statusKey = `status-${(o.status || 'Processing').toLowerCase().replace(/\s+/g, '-')}`;
                    const statusText = translations[currentLang][statusKey] || o.status;
                    const statusClass = (o.status || 'Processing').toLowerCase().replace(/\s+/g, '-');
                    return `
                                    <div class="order-list-item">
                                        <div class="order-main">
                                            <span class="order-id">#${o.orderNumber}</span>
                                            <span class="order-date">${new Date(o.date || o.orderDate).toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                                        </div>
                                        <div class="order-meta">
                                            <span class="order-total">${o.total.toLocaleString()} ${currentLang === 'ar' ? 'ج.م' : 'EGP'}</span>
                                            <span class="status-badge-small badge-${statusClass}">${statusText}</span>
                                        </div>
                                    </div>
                                `}).join('') : `<div class="empty-state-small">${translations[currentLang]['modal-no-orders']}</div>`}
                            </div>
                        </div>

                        <!-- Addresses Card -->
                        <div class="detail-card">
                            <div class="detail-header">
                                <div class="header-icon location">
                                    <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                </div>
                                <h3>${translations[currentLang]['admin-addresses-title']} (${userAddresses.length})</h3>
                            </div>
                            <div class="addresses-list">
                                ${userAddresses.length > 0 ? userAddresses.map(a => `
                                    <div class="address-box">
                                        <div class="address-icon">
                                            <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                        </div>
                                        <div class="address-details">
                                            <p class="addr-line">${a.address}</p>
                                            <p class="addr-city">${a.city}, ${a.governorate || ''}</p>
                                            <p class="addr-phone phone-number">${a.phone}</p>
                                        </div>
                                    </div>
                                `).join('') : `<div class="empty-state-small">${translations[currentLang]['admin-no-addresses']}</div>`}
                            </div>
                        </div>
                    </div>
                `;

                content.innerHTML = html;
                document.getElementById('customerDetailsModal').classList.add('active');
            } catch (error) {
                console.error('Error showing details:', error);
                alert('Error showing details');
            }
        }

        // Close Details Modal
        function closeDetailsModal() {
            document.getElementById('customerDetailsModal').classList.remove('active');
        }

        // Load Dashboard
        let revenueChart = null;
        let orderStatusChart = null;

        async function loadDashboard() {
            try {
                const orders = await window.localDB.getAllData('orders');
                const users = await window.localDB.getAllData('users');
                const addresses = await window.localDB.getAllData('addresses');

                // Render Charts
                renderRevenueChart(orders);
                renderOrderStatusChart(orders);

                // Render Recent Activity
                renderRecentOrders(orders, users);
                renderRecentCustomers(users);

                // Render Data Tables
                renderDataTables(orders, users, addresses);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Revenue Trend Chart (Last 7 Days)
        function renderRevenueChart(orders) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;

            // Destroy existing chart
            if (revenueChart) {
                revenueChart.destroy();
            }

            // Get last 7 days
            const last7Days = [];
            const revenueByDay = {};

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
                revenueByDay[dateStr] = 0;
            }

            // Calculate revenue per day
            orders.forEach(order => {
                const orderDate = new Date(order.date || order.orderDate).toISOString().split('T')[0];
                if (revenueByDay.hasOwnProperty(orderDate)) {
                    revenueByDay[orderDate] += order.total || 0;
                }
            });

            const data = last7Days.map(date => revenueByDay[date]);
            const labels = last7Days.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${translations[currentLang]['metric-revenue']} (${currentLang === 'ar' ? 'ج.م' : 'EGP'})`,
                        data: data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Order Status Chart
        function renderOrderStatusChart(orders) {
            const ctx = document.getElementById('orderStatusChart');
            if (!ctx) return;

            // Destroy existing chart
            if (orderStatusChart) {
                orderStatusChart.destroy();
            }

            const statusCount = {
                'Processing': 0,
                'Shipped': 0,
                'Out for Delivery': 0,
                'Delivered': 0
            };

            orders.forEach(order => {
                let status = order.status || 'Processing';
                // Map 'Completed' to 'Delivered' for backward compatibility if needed, or just count it
                if (status === 'Completed') status = 'Delivered';

                if (statusCount.hasOwnProperty(status)) {
                    statusCount[status]++;
                }
            });

            orderStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Processing', 'Shipped', 'Out for Delivery', 'Delivered'],
                    datasets: [{
                        data: [
                            statusCount['Processing'],
                            statusCount['Shipped'],
                            statusCount['Out for Delivery'],
                            statusCount['Delivered']
                        ],
                        backgroundColor: [
                            '#3b82f6', // Processing - Blue
                            '#f59e0b', // Shipped - Amber
                            '#8b5cf6', // Out for Delivery - Violet
                            '#10b981'  // Delivered - Emerald
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Recent Orders
        function renderRecentOrders(orders, users) {
            const container = document.getElementById('recentOrders');
            if (!container) return;

            const recentOrders = orders
                .sort((a, b) => new Date(b.date || b.orderDate) - new Date(a.date || a.orderDate))
                .slice(0, 5);

            if (recentOrders.length === 0) {
                container.innerHTML = `<p style="color: #9ca3af; text-align: center;">${translations[currentLang]['orders-empty']}</p>`;
                return;
            }

            let html = '';
            recentOrders.forEach(order => {
                const user = users.find(u => u.id === order.userId);
                const customerName = order.shipping ? `${order.shipping.firstName} ${order.shipping.lastName}` : (user?.name || 'Unknown');
                const date = new Date(order.date || order.orderDate);
                const timeAgo = getTimeAgo(date);

                html += `
                    <div style="padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <p style="font-weight: 600; margin-bottom: 4px;">${customerName}</p>
                                <p style="font-size: 13px; color: #6b7280;">#${order.orderNumber}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="font-weight: 600; color: #2563eb;">${order.total.toLocaleString()} ${currentLang === 'ar' ? 'ج.م' : 'EGP'}</p>
                                <p style="font-size: 12px; color: #9ca3af;">${timeAgo}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Recent Customers
        function renderRecentCustomers(users) {
            const container = document.getElementById('recentCustomers');
            if (!container) return;

            const recentUsers = users
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);

            if (recentUsers.length === 0) {
                container.innerHTML = `<p style="color: #9ca3af; text-align: center;">${translations[currentLang]['admin-no-customers']}</p>`;
                return;
            }

            let html = '';
            recentUsers.forEach(user => {
                const date = new Date(user.createdAt);
                const timeAgo = getTimeAgo(date);

                html += `
                    <div style="padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-weight: 600; margin-bottom: 4px;">${user.name}</p>
                                <p style="font-size: 13px; color: #6b7280;">${user.email}</p>
                            </div>
                            <p style="font-size: 12px; color: #9ca3af;">${timeAgo}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const r = new Intl.RelativeTimeFormat(currentLang, { numeric: 'auto' });

            if (seconds < 60) return r.format(-seconds, 'second');
            if (seconds < 3600) return r.format(-Math.floor(seconds / 60), 'minute');
            if (seconds < 86400) return r.format(-Math.floor(seconds / 3600), 'hour');
            if (seconds < 604800) return r.format(-Math.floor(seconds / 86400), 'day');
            return date.toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-US');
        }

        // Render Data Tables
        function renderDataTables(orders, users, addresses) {
            const grid = document.getElementById('dashboardContent');
            if (!grid) return;

            let html = '';

            // Orders Table
            // Orders Table
            html += `<div class="card" style="margin-bottom: 20px;"><h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">${translations[currentLang]['admin-orders']}</h3>`;
            if (orders.length > 0) {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;">';
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-order-id']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-date']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-customer']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-items']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-total']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-status']}</th>`;
                html += '</tr></thead><tbody>';

                orders.forEach(order => {
                    const user = users.find(u => u.id === order.userId);
                    const customerName = order.shipping ? `${order.shipping.firstName} ${order.shipping.lastName}` : (user?.name || 'Unknown');
                    const statusColor = order.status === 'Completed' ? '#10b981' : '#f59e0b';

                    html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
                    html += `<td style="padding: 12px;">${order.orderNumber}</td>`;
                    html += `<td style="padding: 12px;">${new Date(order.date || order.orderDate).toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>`;
                    html += `<td style="padding: 12px;">${customerName}</td>`;
                    html += `<td style="padding: 12px;">${order.items?.length || 0}</td>`;
                    html += `<td style="padding: 12px; font-weight: 600;">${order.total.toLocaleString()} EGP</td>`;
                    const statusKey = `status-${order.status.toLowerCase().replace(/\s+/g, '-')}`;
                    const statusText = translations[currentLang][statusKey] || order.status;
                    html += `<td style="padding: 12px;"><span style="padding: 4px 12px; border-radius: 12px; background: ${statusColor}20; color: ${statusColor}; font-size: 12px; font-weight: 600;">${statusText}</span></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            } else {
                html += `<p style="color: #9ca3af; text-align: center; padding: 20px;">${translations[currentLang]['admin-no-orders']}</p>`;
            }
            html += '</div>';

            // Users Table
            // Users Table
            html += `<div class="card" style="margin-bottom: 20px;"><h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">${translations[currentLang]['admin-customers-title']}</h3>`;
            if (users.length > 0) {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;">';
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-name']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-email']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-phone']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-registered']}</th>`;
                html += '</tr></thead><tbody>';

                users.forEach(user => {
                    // Find phone from addresses
                    const userAddress = addresses.find(a => a.userId === user.id);
                    const phone = userAddress ? userAddress.phone : 'N/A';

                    html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
                    html += `<td style="padding: 12px; font-weight: 600;">${user.name}</td>`;
                    html += `<td style="padding: 12px;">${user.email}</td>`;
                    html += `<td style="padding: 12px;" class="phone-number">${phone}</td>`;
                    html += `<td style="padding: 12px;">${new Date(user.createdAt).toLocaleDateString()}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            } else {
                html += `<p style="color: #9ca3af; text-align: center; padding: 20px;">${translations[currentLang]['admin-no-customers']}</p>`;
            }
            html += '</div>';

            // Addresses Table
            // Addresses Table
            html += `<div class="card"><h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">${translations[currentLang]['admin-addresses-title']}</h3>`;
            if (addresses.length > 0) {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;">';
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-customer']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-address']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-city']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-governorate']}</th>`;
                html += `<th style="text-align: left; padding: 12px; font-weight: 600;">${translations[currentLang]['th-phone']}</th>`;
                html += '</tr></thead><tbody>';

                addresses.forEach(addr => {
                    const user = users.find(u => u.id === addr.userId);
                    html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
                    html += `<td style="padding: 12px;">${user?.name || 'Unknown'}</td>`;
                    html += `<td style="padding: 12px;">${addr.address}</td>`;
                    html += `<td style="padding: 12px;">${addr.city}</td>`;
                    html += `<td style="padding: 12px;">${addr.governorate || 'N/A'}</td>`;
                    html += `<td style="padding: 12px;" class="phone-number">${addr.phone}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            } else {
                html += `<p style="color: #9ca3af; text-align: center; padding: 20px;">${translations[currentLang]['admin-no-addresses']}</p>`;
            }
            html += '</div>';

            grid.innerHTML = html;
        }

        // Delete Order
        async function deleteOrder(orderId) {
            const confirmTitle = translations[currentLang]['orders-confirm-delete'] || (currentLang === 'ar' ? 'تأكيد الحذف' : 'Confirm Delete');
            const confirmMsg = currentLang === 'ar' ? 'هل أنت متأكد أنك تريد حذف هذا الطلب؟' : 'Are you sure you want to delete this order?';
            if (await showConfirm(confirmTitle, confirmMsg)) {
                try {
                    // Convert to number for IndexedDB
                    const id = Number(orderId);
                    await window.localDB.deleteData('orders', id);
                    loadOrders();
                    loadAllData();
                    alert('Order deleted successfully!');
                } catch (error) {
                    console.error('Error deleting order:', error);
                    alert('Error deleting order');
                }
            }
        }

        // Show Add Customer Modal
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('active');
        }

        // Close Add Customer Modal
        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('active');
            document.getElementById('addCustomerForm').reset();
        }

        // Add Customer Form Submit
        document.getElementById('addCustomerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('customerName').value;
            const email = document.getElementById('customerEmail').value;
            const password = document.getElementById('customerPassword').value;

            try {
                await window.localDB.registerUser(email, password, name);
                closeAddCustomerModal();
                loadAccounts();
                loadAllData();
                alert('Customer added successfully!');
            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Error adding customer: ' + error.message);
            }
        });

        // --- Create Order Logic ---

        // Show Create Order Modal
        async function showCreateOrderModal() {
            const modal = document.getElementById('createOrderModal');
            const select = document.getElementById('orderCustomerSelect');
            const datalist = document.getElementById('productsList');

            // Populate customers
            try {
                const users = await window.localDB.getAllData('users');
                const manualText = translations.ar['lbl-manual-entry'] || 'جديد';
                select.innerHTML = `<option value="">${manualText}</option>`;
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.email})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users for dropdown:', error);
            }

            // Populate products datalist with Arabic names
            if (typeof products !== 'undefined') {
                datalist.innerHTML = '';
                products.forEach(product => {
                    const option = document.createElement('option');
                    // Use Arabic name if available, otherwise fallback to English
                    option.value = product.nameAr || product.name;
                    datalist.appendChild(option);
                });
            }

            // Reset form
            document.getElementById('createOrderForm').reset();
            document.getElementById('orderItemsContainer').innerHTML = ''; // Clear container
            addOrderItem(); // Add first item
            calculateGrandTotal(); // Initial total

            modal.classList.add('active');
        }

        // Calculate Grand Total
        function calculateGrandTotal() {
            let grandTotal = 0;
            const rows = document.querySelectorAll('.order-item-row');
            rows.forEach(row => {
                const price = Number(row.querySelector('.item-price').value) || 0;
                const qty = Number(row.querySelector('.item-qty').value) || 1;
                grandTotal += price * qty;
            });

            const totalDisplay = document.getElementById('orderGrandTotal');
            if (totalDisplay) {
                totalDisplay.textContent = grandTotal.toLocaleString() + (currentLang === 'ar' ? ' ج.م' : ' EGP');
            }
        }

        // Update Item Price based on selection (supports both Arabic and English names)
        function updateItemPrice(input) {
            if (typeof products === 'undefined') return;

            const productName = input.value.trim();
            // Search by both Arabic name and English name
            const product = products.find(p =>
                p.nameAr === productName || p.name === productName
            );

            if (product) {
                const row = input.closest('.order-item-row');
                const priceInput = row.querySelector('.item-price');
                priceInput.value = product.price;
            }
            calculateGrandTotal();
        }

        // Close Create Order Modal
        function closeCreateOrderModal() {
            document.getElementById('createOrderModal').classList.remove('active');
            hideOrderError(); // Clear any error messages
        }

        // Add Order Item Row
        function addOrderItem() {
            const container = document.getElementById('orderItemsContainer');
            const itemNamePh = translations[currentLang]['ph-item-name'] || (currentLang === 'ar' ? 'اسم المنتج' : 'Item Name');
            const pricePh = translations[currentLang]['ph-price'] || (currentLang === 'ar' ? 'السعر' : 'Price');
            const qtyPh = translations[currentLang]['ph-qty'] || (currentLang === 'ar' ? 'الكمية' : 'Qty');

            const div = document.createElement('div');
            div.className = 'order-item-row';
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 12px; align-items: center;';
            div.innerHTML = `
                <input type="text" class="item-name" list="productsList" placeholder="${itemNamePh}" oninput="updateItemPrice(this)" required style="flex: 2; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                <input type="number" class="item-price" placeholder="${pricePh}" oninput="calculateGrandTotal()" required style="flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                <input type="number" class="item-qty" placeholder="${qtyPh}" value="1" min="1" oninput="calculateGrandTotal()" required style="width: 70px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;">
                <button type="button" onclick="removeOrderItem(this)" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background: #fee2e2; color: #ef4444; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2.5;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            container.appendChild(div);
            calculateGrandTotal();
        }

        // Remove Order Item Row
        function removeOrderItem(btn) {
            const rows = document.querySelectorAll('.order-item-row');
            if (rows.length > 1) {
                btn.parentElement.remove();
                calculateGrandTotal();
            } else {
                alert('Order must have at least one item.');
            }
        }

        // Handle Customer Selection
        function handleCustomerSelect() {
            const select = document.getElementById('orderCustomerSelect');
            const userId = select.value;
            const guestFields = document.getElementById('guestCustomerFields');
            const nameInput = document.getElementById('orderCustomerName');
            const emailInput = document.getElementById('orderCustomerEmail');

            if (userId) {
                // Registered customer selected
                guestFields.style.display = 'none';
                nameInput.removeAttribute('required');
            } else {
                // Guest / Manual entry
                guestFields.style.display = 'block';
                nameInput.setAttribute('required', 'required');
            }
        }

        // Error Display Functions
        function showOrderError(messageKey) {
            const errorDiv = document.getElementById('orderFormError');
            const errorText = document.getElementById('orderFormErrorText');
            if (errorDiv && errorText) {
                errorText.textContent = translations.ar[messageKey] || messageKey;
                errorDiv.style.display = 'block';
                // Scroll to top to show error
                const form = document.getElementById('createOrderForm');
                if (form) form.scrollTop = 0;
            }
        }

        function hideOrderError() {
            const errorDiv = document.getElementById('orderFormError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        // Handle Create Order Submit - Wrapped in function to ensure it runs after DOM loads
        function initCreateOrderForm() {
            const form = document.getElementById('createOrderForm');
            if (!form) {
                console.error('Create order form not found');
                return;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Form submitted, preventing default');
                hideOrderError(); // Clear previous errors

                try {
                    // Clear all previous invalid states
                    form.querySelectorAll('.invalid-field').forEach(field => {
                        field.classList.remove('invalid-field');
                    });

                    // Validate required fields
                    let firstInvalidField = null;
                    const requiredFields = form.querySelectorAll('[required]');
                    let hasEmptyFields = false;

                    requiredFields.forEach(field => {
                        const value = field.value.trim();
                        if (!value) {
                            field.classList.add('invalid-field');
                            hasEmptyFields = true;
                            if (!firstInvalidField) firstInvalidField = field;
                        }
                    });

                    if (hasEmptyFields) {
                        showOrderError('err-fill-required');
                        if (firstInvalidField) firstInvalidField.focus();
                        return;
                    }

                    const address = document.getElementById('orderAddress').value;
                    const city = document.getElementById('orderCity').value;
                    const governorate = document.getElementById('orderGovernorate').value;
                    const phone = document.getElementById('orderPhone').value;
                    const status = document.getElementById('orderStatus').value;

                    // Gather and validate items
                    const items = [];
                    let total = 0;
                    let hasInvalidItem = false;

                    document.querySelectorAll('.order-item-row').forEach(row => {
                        const name = row.querySelector('.item-name').value.trim();
                        const price = Number(row.querySelector('.item-price').value);
                        const quantity = Number(row.querySelector('.item-qty').value);

                        if (name && price > 0 && quantity > 0) {
                            items.push({ name, price, quantity });
                            total += price * quantity;
                        } else if (name || price || quantity) {
                            // Item has some data but is invalid
                            hasInvalidItem = true;
                        }
                    });

                    if (hasInvalidItem) {
                        const priceInputs = document.querySelectorAll('.item-price');
                        const qtyInputs = document.querySelectorAll('.item-qty');
                        let errorShown = false;

                        priceInputs.forEach(input => {
                            if (input.value && Number(input.value) <= 0) {
                                showOrderError('err-invalid-price');
                                errorShown = true;
                            }
                        });

                        if (!errorShown) {
                            qtyInputs.forEach(input => {
                                if (input.value && Number(input.value) <= 0) {
                                    showOrderError('err-invalid-qty');
                                    errorShown = true;
                                }
                            });
                        }

                        return;
                    }

                    if (items.length === 0) {
                        showOrderError('err-no-items');
                        return;
                    }

                    // Get user details or use guest info
                    const customerSelect = document.getElementById('orderCustomerSelect');
                    const userId = customerSelect.value ? Number(customerSelect.value) : null;
                    let firstName, lastName, email;

                    if (userId) {
                        // Registered customer
                        const user = await window.localDB.getData('users', userId);
                        const nameParts = user.name.trim().split(/\s+/);
                        firstName = nameParts[0] || 'Customer';
                        lastName = nameParts.slice(1).join(' ') || '';
                        email = user.email;
                    } else {
                        // Manual entry (Guest)
                        const customerName = document.getElementById('orderCustomerName').value.trim();
                        email = document.getElementById('orderCustomerEmail').value.trim() || 'guest@example.com';

                        if (!customerName) {
                            showOrderError('err-no-customer-name');
                            return;
                        }

                        const nameParts = customerName.split(/\s+/);
                        firstName = nameParts[0];
                        lastName = nameParts.slice(1).join(' ') || '';
                    }

                    const newOrder = {
                        userId: userId,
                        orderNumber: 'ORD-' + Date.now().toString().slice(-6),
                        date: new Date().toISOString(),
                        status: status,
                        total: total,
                        items: items,
                        shipping: {
                            firstName: firstName,
                            lastName: lastName,
                            address: address,
                            city: city,
                            governorate: governorate,
                            phone: phone,
                            email: email
                        }
                    };

                    await window.localDB.addData('orders', newOrder);

                    closeCreateOrderModal();
                    loadOrders();
                    loadAllData();

                    // Show success message
                    showOrderError('err-order-created');
                    setTimeout(() => hideOrderError(), 3000);

                } catch (error) {
                    console.error('Error creating order:', error);
                    showOrderError('err-order-failed');
                }
            });

            // Remove invalid-field class when user starts typing
            const formInputs = form.querySelectorAll('input[required], select[required], textarea[required]');
            formInputs.forEach(input => {
                input.addEventListener('input', function () {
                    if (this.classList.contains('invalid-field')) {
                        this.classList.remove('invalid-field');
                    }
                });
            });

            // Add Egyptian phone validation
            const phoneInput = document.getElementById('orderPhone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function () {
                    // Remove invalid class first
                    this.classList.remove('invalid-field');

                    const value = this.value;

                    // Check if it starts with valid Egyptian prefix
                    if (value.length >= 3) {
                        const prefix = value.substring(0, 3);
                        if (!['010', '011', '012', '015'].includes(prefix)) {
                            this.classList.add('invalid-field');
                            showOrderError('err-invalid-phone');
                        } else {
                            hideOrderError();
                        }
                    }

                    // Check exact length when complete
                    if (value.length === 11) {
                        const egyptPhonePattern = /^(010|011|012|015)[0-9]{8}$/;
                        if (!egyptPhonePattern.test(value)) {
                            this.classList.add('invalid-field');
                            showOrderError('err-invalid-phone');
                        } else {
                            this.classList.remove('invalid-field');
                            hideOrderError();
                        }
                    }
                });
            }
        }

        // Auto-load on page load
        // The original setTimeout is replaced by the new login check logic below.
    </script>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal active">

        <!-- Modal Header with Logo -->
        <div class="login-header">
            <img src="images/mobile-logo.png" alt="Logo">
        </div>

        <div class="modal-content login-content">
            <h2 style="margin-bottom: 30px; color: #1f2937; font-size: 24px; font-weight: 700;"
                data-i18n="admin-login-title">Admin Login</h2>
            <form id="adminLoginForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label
                        style="text-align: left; display: block; margin-bottom: 8px; font-weight: 500; color: #4b5563;"
                        data-i18n="ph-username">Username</label>
                    <input type="text" id="adminUsername" required class="form-control" placeholder="Enter username"
                        style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px;">
                </div>
                <div class="form-group" style="margin-bottom: 30px;">
                    <label
                        style="text-align: left; display: block; margin-bottom: 8px; font-weight: 500; color: #4b5563;"
                        data-i18n="ph-password">Password</label>
                    <input type="password" id="adminPassword" required class="form-control" placeholder="Enter password"
                        style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px;">
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600; border-radius: 8px; background: #2563eb; color: white; border: none; cursor: pointer; transition: background 0.2s;"
                    data-i18n="btn-login">Login</button>
            </form>
        </div>
    </div>



    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <div id="confirmModalIcon" class="confirm-modal-icon">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <h3 id="confirmTitle" class="confirm-modal-title">Confirm Action</h3>
            <p id="confirmMessage" class="confirm-modal-message">Are you sure you want to proceed?</p>
            <div class="confirm-actions">
                <button id="confirmCancelBtn" class="btn btn-secondary" data-i18n="btn-cancel">Cancel</button>
                <button id="confirmConfirmBtn" class="btn btn-danger" data-i18n="btn-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="JS/translations.js"></script>
    <script src="JS/data.js"></script>
    <script src="JS/db.js"></script>
    <script>
        // Check Admin Login
        function showConfirm(title, message, isDanger = true) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const confirmBtn = document.getElementById('confirmConfirmBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');
                const iconContainer = document.getElementById('confirmModalIcon');

                titleEl.textContent = title;
                messageEl.textContent = message;

                // Update button text from translations if available
                confirmBtn.textContent = translations[currentLang]['btn-confirm'] || 'Confirm';
                cancelBtn.textContent = translations[currentLang]['btn-cancel'] || 'Cancel';

                if (isDanger) {
                    confirmBtn.className = 'btn btn-danger';
                    iconContainer.className = 'confirm-modal-icon';
                } else {
                    confirmBtn.className = 'btn btn-primary';
                    iconContainer.className = 'confirm-modal-icon warning';
                }

                modal.classList.add('active');

                const handleConfirm = () => {
                    modal.classList.remove('active');
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.remove('active');
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }

        function checkAdminLogin() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            const loginModal = document.getElementById('adminLoginModal');

            if (isLoggedIn === 'true') {
                loginModal.classList.remove('active');
                loadAllData();
            } else {
                loginModal.classList.add('active');
            }
        }

        // Handle Login Submit
        document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (username === 'admin' && password === 'admin') {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('adminLoginModal').classList.remove('active');
                loadAllData();
            } else {
                alert('Invalid credentials!');
            }
        });

        // Initialize global data arrays
        let orders = [];
        let users = [];
        let addresses = [];
        let currentLang = 'ar'; // Fixed to Arabic only for admin dashboard

        // Apply Translations (Arabic only for admin dashboard)
        function applyTranslations() {
            // Force RTL direction for Arabic
            document.documentElement.dir = 'rtl';
            document.body.classList.add('rtl');

            // Update static text with Arabic translations
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations.ar[key]) {
                    element.textContent = translations.ar[key];
                }
            });

            // Update placeholders with Arabic
            const usernameInput = document.getElementById('adminUsername');
            const passwordInput = document.getElementById('adminPassword');
            if (usernameInput) usernameInput.placeholder = translations.ar['ph-username'];
            if (passwordInput) passwordInput.placeholder = translations.ar['ph-password'];

            // Create Order Form Placeholders
            const orderName = document.getElementById('orderCustomerName');
            const orderEmail = document.getElementById('orderCustomerEmail');
            const orderAddr = document.getElementById('orderAddress');
            const orderCity = document.getElementById('orderCity');
            const orderGov = document.getElementById('orderGovernorate');
            const orderPhone = document.getElementById('orderPhone');

            if (orderName) orderName.placeholder = translations.ar['ph-fullname'];
            if (orderEmail) orderEmail.placeholder = translations.ar['ph-email'];
            if (orderAddr) orderAddr.placeholder = translations.ar['ph-address'];
            if (orderCity) orderCity.placeholder = translations.ar['ph-city'];
            if (orderGov) orderGov.placeholder = translations.ar['ph-gov'];
            if (orderPhone) orderPhone.placeholder = translations.ar['ph-phone'];

            // Add Customer Form Placeholders
            const custName = document.getElementById('customerName');
            const custEmail = document.getElementById('customerEmail');
            const custPass = document.getElementById('customerPassword');
            if (custName) custName.placeholder = translations.ar['ph-fullname'];
            if (custEmail) custEmail.placeholder = translations.ar['ph-email'];
            if (custPass) custPass.placeholder = translations.ar['ph-password'];
        }

        // Load All Data
        async function loadAllData() {
            try {
                orders = await window.localDB.getAllData('orders');
                users = await window.localDB.getAllData('users');
                addresses = await window.localDB.getAllData('addresses');

                loadDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Auto-load on page load
        window.addEventListener('load', () => {
            // Initialize form event listeners
            initCreateOrderForm();

            // Wait for DB to be ready then check login
            if (window.localDB) {
                if (window.localDB.isInitialized) {
                    checkAdminLogin();
                    applyTranslations(); // Initialize translations
                } else {
                    window.addEventListener('localDBReady', () => {
                        checkAdminLogin();
                        applyTranslations();
                    });
                }
            } else {
                // Fallback if DB script loads late
                setTimeout(checkAdminLogin, 500);
            }
        });
    </script>
    <div id="createOrderModal" class="modal">
        <div class="modal-content"
            style="max-width: 650px; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header"
                style="background: #2563eb; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 20px; font-weight: 700;" data-i18n="modal-create-order">Create New
                    Order
                </h2>
                <button class="close-modal-btn" onclick="closeCreateOrderModal()"
                    style="color: white; padding: 0; position: static;">
                    <svg viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"></line>
                        <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"></line>
                    </svg>
                </button>
            </div>

            <form id="createOrderForm"
                style="padding: 30px; display: flex; flex-direction: column; gap: 20px; max-height: calc(90vh - 80px); overflow-y: auto;">

                <!-- Error Display Area -->
                <div id="orderFormError"
                    style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px 16px; color: #dc2626; font-size: 14px; font-weight: 500; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 20px; height: 20px; flex-shrink: 0;" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor">
                            <path
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span id="orderFormErrorText"></span>
                    </div>
                </div>

                <!-- Customer Section -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-weight: 700; color: #1e293b; margin-bottom: 12px;"
                            data-i18n="label-customer">Customer</label>
                        <select id="orderCustomerSelect" onchange="handleCustomerSelect()"
                            style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; background: white; outline: none; transition: border-color 0.2s;">
                            <option value="" data-i18n="lbl-manual-entry">Manual Entry</option>
                        </select>
                    </div>

                    <div id="guestCustomerFields"
                        style="display: block; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #cbd5e1;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label style="font-size: 13px;" data-i18n="label-fullname">Full Name</label>
                                <input type="text" id="orderCustomerName" placeholder="Full Name"
                                    style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px;">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 13px;" data-i18n="label-email">Email Address</label>
                                <input type="email" id="orderCustomerEmail" placeholder="Email"
                                    style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items Section -->
                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <label style="font-weight: 700; color: #1e293b;" data-i18n="lbl-order-items">Order Items</label>
                        <button type="button" onclick="addOrderItem()"
                            style="padding: 6px 12px; background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 700; transition: all 0.2s;">
                            + <span data-i18n="btn-add-item">Add Item</span>
                        </button>
                    </div>

                    <div id="orderItemsContainer">
                        <!-- Items added here scripts -->
                    </div>

                    <div
                        style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 700; color: #64748b;" data-i18n="label-total">Total Amount:</span>
                        <span id="orderGrandTotal" style="font-size: 20px; font-weight: 800; color: #2563eb;">0
                            EGP</span>
                    </div>
                </div>

                <!-- Shipping Section -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <label style="font-weight: 700; color: #1e293b; margin-bottom: 15px; display: block;"
                        data-i18n="lbl-shipping">Shipping Information</label>
                    <div class="form-group">
                        <input type="text" id="orderAddress" required placeholder="Full Shipping Address"
                            style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; margin-bottom: 15px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <input type="text" id="orderCity" required placeholder="City"
                                style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px;">
                        </div>
                        <div class="form-group">
                            <input type="text" id="orderGovernorate" required placeholder="Governorate"
                                list="governoratesList"
                                style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <input type="tel" id="orderPhone" required placeholder="Phone Number" class="phone-number"
                                pattern="^(010|011|012|015)[0-9]{8}$" maxlength="11"
                                title="الرجاء إدخال رقم هاتف مصري صحيح (مثل: 01012345678)"
                                onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px;">
                        </div>
                        <div class="form-group">
                            <select id="orderStatus"
                                style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; height: 100%; font-size: 14px;">
                                <option value="Processing" data-i18n="status-processing">Processing</option>
                                <option value="Shipped" data-i18n="status-shipped">Shipped</option>
                                <option value="Out for Delivery" data-i18n="status-out-for-delivery">Out for Delivery
                                </option>
                                <option value="Delivered" data-i18n="status-delivered">Delivered</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; padding-top: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateOrderModal()"
                        style="flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; background: #e2e8f0; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center;"
                        data-i18n="btn-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary"
                        style="flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; background: #2563eb; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center;"
                        data-i18n="btn-create">Create Order</button>
                </div>
            </form>
        </div>
    </div>
    <datalist id="productsList"></datalist>

    <!-- Egyptian Governorates Datalist -->
    <datalist id="governoratesList">
        <option value="القاهرة">
        <option value="الجيزة">
        <option value="الإسكندرية">
        <option value="الدقهلية">
        <option value="البحيرة">
        <option value="الفيوم">
        <option value="الغربية">
        <option value="الإسماعيلية">
        <option value="المنوفية">
        <option value="المنيا">
        <option value="القليوبية">
        <option value="الوادي الجديد">
        <option value="الشرقية">
        <option value="سوهاج">
        <option value="شمال سيناء">
        <option value="جنوب سيناء">
        <option value="بني سويف">
        <option value="بورسعيد">
        <option value="دمياط">
        <option value="الأقصر">
        <option value="أسوان">
        <option value="أسيوط">
        <option value="البحر الأحمر">
        <option value="السويس">
        <option value="كفر الشيخ">
        <option value="مطروح">
        <option value="قنا">
    </datalist>
</body>

</html>
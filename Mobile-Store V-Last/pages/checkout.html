<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Mobile Store</title>
  <link rel="icon" type="image/png" href="../images/checkout.png">
  <link rel="stylesheet" href="../CSS/style.css">

  <style>
    /* ========== BASE STYLES ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
    }

    /* ========== HEADER ========== */
    .checkout-header {
      background: white;
      padding: 20px 5%;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 40px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Logo styles removed to use global CSS */

    .back-btn {
      background: #f3f4f6;
      color: #1f2937;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: #e5e7eb;
    }

    /* ========== CONTAINER ========== */
    .checkout-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 5% 60px;
    }

    /* ========== PROGRESS STEPS ========== */
    .progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 50px;
      position: relative;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 2;
      flex: 1;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 3px;
      background: #e5e7eb;
      z-index: -1;
    }

    .step.completed:not(:last-child)::after {
      background: #10b981;
    }

    .step.active:not(:last-child)::after {
      background: linear-gradient(90deg, #10b981 0%, #e5e7eb 100%);
    }

    .step-number {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: white;
      border: 3px solid #e5e7eb;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .step.active .step-number {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
      box-shadow: 0 0 0 5px rgba(37, 99, 235, 0.2);
    }

    .step.completed .step-number {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    .step-label {
      font-size: 14px;
      font-weight: 600;
      color: #9ca3af;
      transition: all 0.3s;
    }

    .step.active .step-label {
      color: #2563eb;
      font-weight: 700;
    }

    .step.completed .step-label {
      color: #10b981;
    }

    /* Remove old arrows */
    .step-arrow {
      display: none;
    }

    /* ========== CHECKOUT CONTENT ========== */
    .checkout-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
    }

    .form-section {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 25px;
    }

    /* ========== FORM ELEMENTS ========== */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 13px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
    }

    /* ========== HEADER ========== */
    .checkout-header {
      background: white;
      padding: 20px 5%;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 40px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }



    .back-btn {
      background: #f3f4f6;
      color: #1f2937;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: #e5e7eb;
    }

    /* ========== CONTAINER ========== */
    .checkout-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 5% 60px;
    }

    /* ========== PROGRESS STEPS ========== */
    .progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 50px;
      gap: 20px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .step.active .step-number {
      background: #2563eb;
      color: white;
    }

    .step.completed .step-number {
      background: #10b981;
      color: white;
    }

    .step-label {
      font-size: 15px;
      font-weight: 600;
      color: #6b7280;
    }

    .step.active .step-label {
      color: #2563eb;
    }

    .step-arrow {
      color: #d1d5db;
      font-size: 20px;
    }

    /* ========== CHECKOUT CONTENT ========== */
    .checkout-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
    }

    .form-section {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 25px;
    }

    /* ========== FORM ELEMENTS ========== */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 13px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    /* Error State */
    .form-group input.error,
    .form-group select.error,
    .form-group textarea.error {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .form-group input.error:focus,
    .form-group select.error:focus,
    .form-group textarea.error:focus {
      border-color: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
    }

    /* Inline Error Message */
    .error-message {
      display: none;
      color: #ef4444;
      font-size: 13px;
      margin-top: 5px;
      font-weight: 500;
    }

    /* Success State */
    .form-group input.success,
    .form-group select.success,
    .form-group textarea.success {
      border-color: #10b981;
    }

    .form-group input.success:focus,
    .form-group select.success:focus,
    .form-group textarea.success:focus {
      border-color: #10b981;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .required {
      color: #ef4444;
    }

    /* ========== ORDER SUMMARY ========== */
    .order-summary {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .summary-title {
      font-size: 22px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 20px;
    }

    #orderItems {
      /* تأكد أن كل منتج في ملخص الطلب يظهر في سطر مستقل داخل الصندوق */
      display: flex !important;
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 10px;
      width: 100%;
      overflow-x: hidden;
    }

    .order-item {
      display: flex !important;
      flex-direction: row;
      align-items: flex-start;
      gap: 15px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .item-image {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .item-quantity {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .item-price {
      font-size: 16px;
      font-weight: 700;
      color: #2563eb;
    }

    .summary-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 20px 0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 15px;
    }

    .summary-row .label {
      color: #6b7280;
      font-weight: 500;
    }

    .summary-row .value {
      color: #1f2937;
      font-weight: 600;
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
      margin-top: 20px;
    }

    .summary-total .label {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
    }

    .summary-total .value {
      font-size: 24px;
      font-weight: 700;
      color: #2563eb;
    }

    /* ========== BUTTONS ========== */
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #6b7280;
      border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    /* ========== REVIEW SECTION ========== */
    .review-section {
      display: none;
    }

    .review-section.active {
      display: block;
    }

    .review-card {
      background: #f9fafb;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .review-card h3 {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 15px;
    }

    /* ========== REVIEW SECTION (VERTICAL STACK) ========== */
    .review-grid {
      display: grid;
      grid-template-columns: 100% !important;
      /* Force Stacking */
      gap: 15px;
      margin-top: 15px;
    }

    .review-card-item {
      background: linear-gradient(to bottom right, #ffffff, #f9fafb);
      border: 1px solid #e5e7eb;
      border-inline-start: 4px solid #2563eb;
      /* Pro Accent */
      border-radius: 12px;
      padding: 18px;
      display: flex;
      align-items: flex-start;
      gap: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
      width: 100%;
      /* Ensure full width */
    }

    .review-card-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.1);
      border-color: #bfdbfe;
    }

    .review-card-item.full-width {
      grid-column: span 2;
    }

    .card-header-action {
      position: absolute;
      top: 12px;
      inset-inline-end: 12px;
      /* RTL Friendly */
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .card-header-action:hover {
      color: #2563eb;
      background: #eff6ff;
    }

    .card-header-action svg {
      width: 16px;
      height: 16px;
    }

    .icon-box {
      width: 42px;
      height: 42px;
      background: #eff6ff;
      color: #2563eb;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .avatar-box {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
    }

    .icon-box svg {
      width: 22px;
      height: 22px;
    }

    .info-content {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
    }

    .info-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #6b7280;
      font-weight: 700;
    }

    .info-value {
      font-size: 15px;
      color: #1f2937;
      font-weight: 600;
      line-height: 1.4;
    }

    .info-value.main {
      font-size: 16px;
      color: #111827;
      font-weight: 700;
    }

    .info-value.sub {
      font-size: 13px;
      color: #4b5563;
      font-weight: 500;
    }

    .dir-ltr {
      direction: ltr;
      text-align: left;
      /* Fallback */
    }

    /* RTL Specific override for LTR fields to ensure they align left within the card */
    [dir="rtl"] .dir-ltr {
      text-align: left;
    }

    /* Mobile Responsive */
    @media (max-width: 600px) {
      .review-grid {
        grid-template-columns: 1fr;
      }

      .review-card-item.full-width {
        grid-column: auto;
      }
    }

    .review-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .review-item:last-child {
      border-bottom: none;
    }

    .review-item .label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
      width: 140px;
      /* Fixed width for better alignment */
      flex-shrink: 0;
    }

    .review-item .value {
      font-size: 15px;
      color: #1f2937;
      font-weight: 600;
      flex: 1;
    }

    /* ========== SUCCESS MESSAGE ========== */
    .success-message {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }

    .success-message.active {
      display: block;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .success-icon svg {
      width: 40px;
      height: 40px;
      stroke: white;
      stroke-width: 3;
      fill: none;
    }

    .success-message h2 {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .success-message p {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 30px;
    }

    .order-number {
      font-size: 18px;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 30px;
    }

    .btn-group-success {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .btn-group-success .btn {
      flex: 0 1 250px;
    }

    /* ========== NOTIFICATION SYSTEM ========== */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 380px;
      pointer-events: none;
    }

    .notification {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: slideInRight 0.4s ease;
      border-left: 4px solid #2563eb;
      position: relative;
      overflow: hidden;
      pointer-events: all;
      min-width: 320px;
      max-width: 380px;
    }

    .notification::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
      animation: progress 4s linear;
    }

    .notification.success {
      border-left-color: #10b981;
    }

    .notification.success::before {
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    }

    .notification.error {
      border-left-color: #ef4444;
    }

    .notification.error::before {
      background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
    }

    .notification.warning {
      border-left-color: #f59e0b;
    }

    .notification.warning::before {
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    }

    .notification-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: #eff6ff;
    }

    .notification.success .notification-icon {
      background: #d1fae5;
    }

    .notification.error .notification-icon {
      background: #fee2e2;
    }

    .notification.warning .notification-icon {
      background: #fef3c7;
    }

    .notification-icon svg {
      width: 20px;
      height: 20px;
      stroke: #2563eb;
      stroke-width: 2.5;
      fill: none;
    }

    .notification.success .notification-icon svg {
      stroke: #10b981;
    }

    .notification.error .notification-icon svg {
      stroke: #ef4444;
    }

    .notification.warning .notification-icon svg {
      stroke: #f59e0b;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-size: 14px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 3px;
      line-height: 1.3;
    }

    .notification-message {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .notification-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: #9ca3af;
      transition: color 0.3s ease;
      flex-shrink: 0;
      font-size: 18px;
      line-height: 1;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-close:hover {
      color: #1f2937;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes progress {
      from {
        width: 100%;
      }

      to {
        width: 0%;
      }
    }

    .notification.fade-out {
      animation: fadeOut 0.4s ease forwards;
    }

    @keyframes fadeOut {
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* Force LTR for specific fields */
    #email,
    #phone,
    #postalCode {
      direction: ltr !important;
      text-align: left !important;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 968px) {
      .checkout-content {
        grid-template-columns: 1fr;
      }

      .order-summary {
        position: static;
        order: -1;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .progress-steps {
        flex-wrap: wrap;
      }
    }

    @media (max-width: 480px) {
      .notification-container {
        left: 10px;
        right: 10px;
        max-width: none;
      }

      .notification {
        min-width: auto;
        max-width: none;
        padding: 14px;
      }

      .notification-icon {
        width: 32px;
        height: 32px;
      }

      .notification-icon svg {
        width: 18px;
        height: 18px;
      }

      .notification-title {
        font-size: 13px;
      }

      .notification-message {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- ========== HEADER ========== -->
  <header class="checkout-header">
    <div class="header-content">
      <div class="logo">
        <img src="../images/mobile-logo.png" alt="Mobile Store Logo">
        <span data-i18n="nav-brand-text">Mobile Store</span>
      </div>
      <button class="back-btn" onclick="window.history.back()" data-i18n="btn-back-shop">← Back to Shop</button>
    </div>
  </header>

  <!-- ========== MAIN CONTAINER ========== -->
  <div class="checkout-container">
    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step active" id="step1">
        <div class="step-number">1</div>
        <div class="step-label" data-i18n="step-shipping">Shipping</div>
      </div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <div class="step-label" data-i18n="step-review">Review</div>
      </div>
      <div class="step" id="step3">
        <div class="step-number">3</div>
        <div class="step-label" data-i18n="step-complete">Complete</div>
      </div>
    </div>

    <!-- Checkout Content -->
    <div class="checkout-content">
      <!-- Shipping Form -->
      <div class="form-section" id="shippingForm">
        <h2 class="section-title" data-i18n="shipping-title">Shipping Details</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="firstName"><span data-i18n="lbl-first-name">First Name</span> <span
                class="required">*</span></label>
            <input type="text" id="firstName" required data-i18n-placeholder="ph-first-name"
              placeholder="Enter first name" pattern="[A-Za-z\u0600-\u06FF\s]{2,50}"
              title="Name should only contain letters and spaces (2-50 characters)" minlength="2" maxlength="50">
            <div class="error-message" id="firstNameError"></div>
          </div>
          <div class="form-group">
            <label for="lastName"><span data-i18n="lbl-last-name">Last Name</span> <span
                class="required">*</span></label>
            <input type="text" id="lastName" required data-i18n-placeholder="ph-last-name" placeholder="Enter last name"
              pattern="[A-Za-z\u0600-\u06FF\s]{2,50}"
              title="Name should only contain letters and spaces (2-50 characters)" minlength="2" maxlength="50">
            <div class="error-message" id="lastNameError"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="email"><span data-i18n="lbl-email">Email Address</span> <span class="required">*</span></label>
          <input type="email" id="email" required data-i18n-placeholder="ph-email" placeholder="your.email@example.com"
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="Please enter a valid email address">
          <div class="error-message" id="emailError"></div>
        </div>

        <div class="form-group">
          <label for="phone"><span data-i18n="lbl-phone">Phone Number</span> <span class="required">*</span></label>
          <input type="tel" id="phone" required data-i18n-placeholder="ph-phone" placeholder="+20 123 456 7890"
            pattern="^(\+20|0)?1[0-2,5]{1}[0-9]{8}$"
            title="Please enter a valid Egyptian phone number (e.g., +20 123 456 7890 or 01234567890)" maxlength="15">
          <div class="error-message" id="phoneError"></div>
        </div>

        <div class="form-group">
          <label for="address"><span data-i18n="lbl-address">Street Address</span> <span
              class="required">*</span></label>
          <input type="text" id="address" required data-i18n-placeholder="ph-address"
            placeholder="Street address, apartment, suite" minlength="5" maxlength="200"
            title="Address should be between 5-200 characters">
          <div class="error-message" id="addressError"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="city"><span data-i18n="lbl-city">City</span> <span class="required">*</span></label>
            <input type="text" id="city" required data-i18n-placeholder="ph-city" placeholder="City"
              pattern="[A-Za-z\u0600-\u06FF\s]{2,50}" title="City name should only contain letters and spaces"
              minlength="2" maxlength="50">
            <div class="error-message" id="cityError"></div>
          </div>
          <div class="form-group">
            <label for="governorate"><span data-i18n="lbl-governorate">Governorate</span> <span
                class="required">*</span></label>
            <select id="governorate" required>
              <option value="" data-i18n="opt-select-gov">Select Governorate</option>
              <option value="Cairo" data-i18n="opt-gov-cairo">Cairo</option>
              <option value="Giza" data-i18n="opt-gov-giza">Giza</option>
              <option value="Alexandria" data-i18n="opt-gov-alex">Alexandria</option>
              <option value="Qalyubia" data-i18n="opt-gov-qal">Qalyubia</option>
              <option value="Sharqia" data-i18n="opt-gov-shar">Sharqia</option>
              <option value="Dakahlia" data-i18n="opt-gov-dak">Dakahlia</option>
              <option value="Other" data-i18n="opt-gov-other">Other</option>
            </select>
            <div class="error-message" id="governorateError"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="postalCode" data-i18n="lbl-postal-code">Postal Code</label>
          <input type="text" id="postalCode" data-i18n-placeholder="ph-postal-code" placeholder="12345"
            pattern="[0-9]{5}" title="Postal code should be exactly 5 digits" maxlength="5">
          <div class="error-message" id="postalCodeError"></div>
        </div>

        <div class="form-group">
          <label for="notes" data-i18n="lbl-notes">Additional Notes (Optional)</label>
          <textarea id="notes" data-i18n-placeholder="ph-notes"
            placeholder="Any special instructions for delivery..."></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="window.history.back()"
            data-i18n="btn-cancel">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitShipping()"
            data-i18n="btn-continue-review">Continue to Review</button>
        </div>
      </div>

      <!-- Review Section -->
      <div class="form-section review-section" id="reviewSection">
        <h2 class="section-title" data-i18n="review-title">Review Your Order</h2>

        <div class="review-card">
          <h3 data-i18n="review-shipping-info">Shipping Information</h3>
          <div id="reviewShipping"></div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="goBackToShipping()" data-i18n="btn-back">←
            Back</button>
          <button type="button" class="btn btn-primary" id="confirmOrderBtn" onclick="confirmOrder()"
            data-i18n="btn-confirm-order">Confirm Order ✓</button>
        </div>
      </div>

      <style>
        /* Advanced Morphing Button */
        #confirmOrderBtn {
          position: relative;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          overflow: hidden;
          min-width: 50px;
          /* Ensure it can shrink */
        }

        /* Hover Effect */
        #confirmOrderBtn:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
        }

        /* Loading State (Morph to Circle) */
        #confirmOrderBtn.loading {
          width: 50px !important;
          /* Force circle width */
          flex: 0 0 50px !important;
          /* Override flex */
          border-radius: 25px;
          color: transparent;
          cursor: default;
          padding: 0;
          background: #2563eb;
          /* Keep solid blue */
        }

        /* Spinner Loader */
        #confirmOrderBtn.loading::after {
          content: '';
          position: absolute;
          width: 24px;
          height: 24px;
          border: 3px solid rgba(255, 255, 255, 0.3);
          border-top-color: #fff;
          border-radius: 50%;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          animation: spin 0.8s linear infinite;
        }

        /* Success State (Green + Check) */
        #confirmOrderBtn.success {
          width: 100% !important;
          /* Expand back */
          flex: 1 !important;
          background: #10b981;
          color: white;
          border-radius: 10px;
        }

        #confirmOrderBtn.success::after {
          display: none;
          /* Hide spinner */
        }

        @keyframes spin {
          to {
            transform: translate(-50%, -50%) rotate(360deg);
          }
        }
      </style>

      <!-- Success Message -->
      <div class="form-section success-message" id="successMessage">
        <div class="success-icon">
          <svg viewBox="0 0 24 24">
            <polyline points="20 6 9 17 4 12" />
          </svg>
        </div>
        <h2 data-i18n="success-title">Order Placed Successfully!</h2>
        <p data-i18n="success-msg">Thank you for your purchase. We'll send you a confirmation email shortly.</p>
        <div class="order-number"><span data-i18n="order-number-prefix">Order #</span><span id="orderNumber"></span>
        </div>
        <div class="btn-group-success">
          <button class="btn btn-primary" onclick="window.location.href='account.html'" data-i18n="btn-view-orders">View
            My Orders</button>
          <button class="btn btn-secondary" onclick="window.location.href='../index.html'"
            data-i18n="btn-continue-shopping">Continue Shopping</button>
        </div>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="order-summary">
        <h2 class="summary-title" data-i18n="summary-title">Order Summary</h2>
        <div id="orderItems"></div>
        <div class="summary-divider"></div>
        <div class="summary-row">
          <span class="label" data-i18n="summary-subtotal">Subtotal</span>
          <span class="value" id="subtotal">0 EGP</span>
        </div>
        <div class="summary-row">
          <span class="label" data-i18n="summary-shipping">Shipping</span>
          <span class="value" data-i18n="summary-free">Free</span>
        </div>
        <div class="summary-total">
          <span class="label" data-i18n="summary-total">Total</span>
          <span class="value" id="total">0 EGP</span>
        </div>
      </div>
    </div>
  </div>

  <script>

    let currentUser = null;
    let cartData = [];

    // Validation Patterns
    const patterns = {
      name: /^[A-Za-z\u0600-\u06FF\s]{2,50}$/,
      email: /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i,
      phone: /^(\+20|0)?1[0-2,5]{1}[0-9]{8}$/,
      postalCode: /^[0-9]{5}$/
    };

    // Notification System
    function showNotification(message, type = 'info', title = '') {
      let container = document.querySelector('.notification-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'notification-container';
        document.body.appendChild(container);
      }

      const icons = {
        success: '<polyline points="20 6 9 17 4 12"/>',
        error: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
        warning: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>',
        info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
      };

      const titles = {
        success: title || 'Success!',
        error: title || 'Error!',
        warning: title || 'Warning!',
        info: title || 'Info'
      };

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
    <div class="notification-icon">
      <svg viewBox="0 0 24 24">${icons[type]}</svg>
    </div>
    <div class="notification-content">
      <div class="notification-title">${titles[type]}</div>
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close" onclick="this.parentElement.remove()">✕</button>
  `;

      container.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 400);
      }, 4000);
    }

    // Make showNotification global
    window.showNotification = showNotification;

    // Helper: Show Inline Error
    function showInlineError(input, message) {
      const formGroup = input.closest('.form-group');
      let errorElement = formGroup.querySelector('.error-message');

      if (!errorElement) {
        errorElement = document.createElement('small');
        errorElement.className = 'error-message';
        formGroup.appendChild(errorElement);
      }

      input.classList.add('error');
      input.classList.remove('success');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    // Helper: Clear Inline Error
    function clearInlineError(input) {
      const formGroup = input.closest('.form-group');
      const errorElement = formGroup.querySelector('.error-message');

      input.classList.remove('error');
      input.classList.add('success');
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }

    // Helper: Validate Single Field
    function validateField(input) {
      const value = input.value.trim();
      const id = input.id;

      const getTrans = (key, fallback) => {
        const lang = localStorage.getItem('lang') || 'en';
        return (window.translations && window.translations[lang] && window.translations[lang][key]) || fallback;
      };

      // Required check
      if (input.hasAttribute('required') && !value) {
        showInlineError(input, getTrans('val-required', 'This field is required'));
        return false;
      }

      // Specific validations
      if (id === 'firstName' || id === 'lastName') {
        if (!patterns.name.test(value)) {
          showInlineError(input, getTrans('val-name-pattern', 'Only letters and spaces allowed (2-50 chars)'));
          return false;
        }
      } else if (id === 'email') {
        if (!patterns.email.test(value)) {
          showInlineError(input, getTrans('val-email-invalid', 'Please enter a valid email address'));
          return false;
        }
      } else if (id === 'phone') {
        const cleanPhone = value.replace(/\s/g, '');
        if (!patterns.phone.test(cleanPhone)) {
          showInlineError(input, getTrans('val-phone-invalid', 'Invalid Egyptian phone number'));
          return false;
        }
      } else if (id === 'postalCode' && value) {
        if (!patterns.postalCode.test(value)) {
          showInlineError(input, getTrans('val-postal-pattern', 'Postal code must be exactly 5 digits'));
          return false;
        }
      } else if (id === 'city') {
        if (!patterns.name.test(value)) {
          showInlineError(input, getTrans('val-city-pattern', 'City name should only contain letters'));
          return false;
        }
      }

      clearInlineError(input);
      return true;
    }

    // Helper: Format Phone Number
    function formatPhoneNumber(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.startsWith('20')) value = value.slice(2); // Remove country code if typed manually

      if (value.length > 11) value = value.slice(0, 11);

      if (value.length > 0) {
        if (value.length <= 3) {
          input.value = value;
        } else if (value.length <= 6) {
          input.value = `${value.slice(0, 3)
            } ${value.slice(3)} `;
        } else {
          input.value = `${value.slice(0, 3)} ${value.slice(3, 6)} ${value.slice(6)} `;
        }
      }
    }

    //   onAuthStateChanged
    window.addEventListener('localDBReady', async () => {
      const user = window.localDB.getCurrentUser();

      if (!user) {
        const lang = localStorage.getItem('lang') || 'en';
        const msg = (window.translations && window.translations[lang] && window.translations[lang]['notif-signin-checkout']) || 'Please sign in to checkout';
        showNotification(msg, 'warning');
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 2000);
        return;
      }

      currentUser = user;
      initCheckout();
    });

    // Initialize Checkout
    function initCheckout() {
      const urlParams = new URLSearchParams(window.location.search);
      const cartParam = urlParams.get('cart');

      // Update page title based on language
      const lang = localStorage.getItem('lang') || 'en';
      const titleKey = 'checkout-title';
      if (window.translations && window.translations[lang] && window.translations[lang][titleKey]) {
        document.title = window.translations[lang][titleKey];
      }

      if (cartParam) {
        try {
          cartData = JSON.parse(decodeURIComponent(cartParam));
        } catch (e) {
          return;
        }

        // Attach Real-time Validation
        const inputs = document.querySelectorAll('.form-group input, .form-group select, .form-group textarea');
        inputs.forEach(input => {
          input.addEventListener('blur', () => validateField(input));
          input.addEventListener('input', () => {
            if (input.id === 'phone') formatPhoneNumber(input);

            // Clear error immediately on typing if it was an error
            if (input.classList.contains('error')) {
              validateField(input);
            }
          });
        });

        // Global Submit Function
        window.submitShipping = function () {
          const firstName = document.getElementById('firstName');
          const lastName = document.getElementById('lastName');
          const email = document.getElementById('email');
          const phone = document.getElementById('phone');
          const address = document.getElementById('address');
          const city = document.getElementById('city');
          const governorate = document.getElementById('governorate');
          const postalCode = document.getElementById('postalCode');
          const notes = document.getElementById('notes');

          // Validate all fields
          const fieldsToValidate = [firstName, lastName, email, phone, address, city, governorate];
          if (postalCode.value) fieldsToValidate.push(postalCode);

          let isValid = true;
          fieldsToValidate.forEach(field => {
            if (!validateField(field)) isValid = false;
          });

          if (!isValid) {
            const lang = localStorage.getItem('lang') || 'en';
            const msg = (window.translations && window.translations[lang] && window.translations[lang]['notif-fix-errors']) || 'Please fix the errors in the form';
            showNotification(msg, 'error');
            return;
          }

          window.shippingData = {
            firstName: firstName.value,
            lastName: lastName.value,
            email: email.value,
            phone: phone.value,
            address: address.value,
            city: city.value,
            governorate: governorate.value,
            postalCode: postalCode.value,
            notes: notes.value
          };

          document.getElementById('step1').classList.add('completed');
          document.getElementById('step1').classList.remove('active');
          document.getElementById('step2').classList.add('active');
          document.getElementById('shippingForm').style.display = 'none';
          document.getElementById('reviewSection').classList.add('active');

          displayReview();
        };

        // Display Cart Items in Summary
        function displayCart() {
          const orderItems = document.getElementById('orderItems');
          const subtotalEl = document.getElementById('subtotal');
          const totalEl = document.getElementById('total');

          if (!orderItems || !subtotalEl || !totalEl) return;

          const lang = localStorage.getItem('lang') || 'en';
          const qtyLabel = (window.translations && window.translations[lang] && window.translations[lang]['label-qty']) || 'Qty:';

          orderItems.innerHTML = cartData.map(item => {
            // Fix image path for pages subdirectory
            let imagePath = item.image;
            if (imagePath && !imagePath.startsWith('http') && !imagePath.startsWith('../')) {
              imagePath = '../' + imagePath;
            }

            // نص يوضح اللون المختار إن وجد
            const colorText = item.color
              ? (item.colorNameAr || item.color)
              : '';

            const colorLabel = colorText
              ? `<span style="color:#6b7280; font-size:13px; margin-inline-start:6px;">- ${colorText}</span>`
              : '';

            // كل منتج داخل كرت مستقل، مع إغلاق صحيح لكل الـ div
            return `
              <div class="order-item">
                <div class="item-image">
                  <img src="${imagePath}" alt="${item.name}">
                </div>
                <div class="item-details">
                  <div class="item-name">
                    ${item.name}
                    ${colorLabel}
                  </div>
                  <div class="item-quantity">${qtyLabel} ${item.quantity}</div>
                  <div class="item-price">${item.price.toLocaleString()} EGP</div>
                </div>
              </div>
            `;
          }).join('');

          const subtotal = cartData.reduce((sum, item) => sum + (item.price * item.quantity), 0);
          subtotalEl.textContent = `${subtotal.toLocaleString()} EGP`;
          totalEl.textContent = `${subtotal.toLocaleString()} EGP`;
        }

        // Call displayCart immediately
        displayCart();

        // Display Review
        function displayReview() {
          const data = window.shippingData;

          const getTrans = (key, fallback) => {
            const lang = localStorage.getItem('lang') || 'en';
            return (window.translations && window.translations[lang] && window.translations[lang][key]) || fallback;
          };

          // Helper to generate initials
          const initials = `${data.firstName.charAt(0)}${data.lastName.charAt(0)}`.toUpperCase();

          let shippingHtml = `
            <div class="review-grid" style="display: grid; grid-template-columns: 100% !important; gap: 15px;">
              <!-- 1. Name & Avatar -->
              <div class="review-card-item" style="width: 100%; position: relative;">
                <div class="card-header-action" onclick="goBackToShipping()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </div>
                <div class="avatar-box">
                  ${initials}
                </div>
                <div class="info-content">
                  <span class="info-label" data-i18n="lbl-full-name">${getTrans('lbl-full-name', 'Full Name')}</span>
                  <span class="info-value main">${data.firstName} ${data.lastName}</span>
                </div>
              </div>

              <!-- 2. Contact Info -->
              <div class="review-card-item" style="width: 100%; position: relative;">
                <div class="card-header-action" onclick="goBackToShipping()">
                   <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </div>
                 <div class="icon-box">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </div>
                <div class="info-content">
                  <span class="info-label" data-i18n="lbl-contact">${getTrans('lbl-contact', 'Contact Info')}</span>
                  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span class="info-value dir-ltr" style="order: 2;">${data.phone}</span>
                    <span style="color: #d1d5db; order: 1;">|</span>
                    <span class="info-value dir-ltr" style="order: 0;">${data.email}</span>
                  </div>
                </div>
              </div>

              <!-- 3. Address -->
              <div class="review-card-item" style="width: 100%; position: relative;">
                <div class="card-header-action" onclick="goBackToShipping()">
                   <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </div>
                 <div class="icon-box">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                </div>
                <div class="info-content">
                  <span class="info-label" data-i18n="lbl-address">${getTrans('lbl-address', 'Address')}</span>
                  <span class="info-value">${data.address}</span>
                  <span class="info-value sub">${data.city}, ${data.governorate} ${data.postalCode ? '- ' + data.postalCode : ''}</span>
                </div>
              </div>
            </div>
      `;

          document.getElementById('reviewShipping').innerHTML = shippingHtml;
        }

        // Go Back to Shipping
        window.goBackToShipping = function () {
          document.getElementById('step2').classList.remove('active');
          document.getElementById('step1').classList.remove('completed');
          document.getElementById('step1').classList.add('active');
          document.getElementById('reviewSection').classList.remove('active');
          document.getElementById('shippingForm').style.display = 'block';
        };

        // Confirm Order
        window.confirmOrder = async function () {
          // Play Animation
          const btn = document.getElementById('confirmOrderBtn');
          if (btn) {
            btn.classList.add('loading');
            // Wait for processing simulation
            await new Promise(resolve => setTimeout(resolve, 1500));

            btn.classList.remove('loading');
            btn.classList.add('success');
            // Wait for success indication
            await new Promise(resolve => setTimeout(resolve, 600));
          }

          const orderNumber = 'ORD' + Date.now().toString().slice(-8);
          const subtotal = cartData.reduce((sum, item) => sum + (item.price * item.quantity), 0);

          const orderData = {
            userId: currentUser.id,
            orderNumber: orderNumber,
            date: new Date().toISOString(),
            status: 'Processing',
            items: cartData,
            shipping: window.shippingData,
            total: subtotal,
            governorate: window.shippingData.governorate,
            city: window.shippingData.city,
            address: window.shippingData.address,
            phone: window.shippingData.phone
          };

          const getTrans = (key, fallback) => {
            const lang = localStorage.getItem('lang') || 'en';
            return (window.translations && window.translations[lang] && window.translations[lang][key]) || fallback;
          };

          try {
            // Save order to Local Database
            await window.localDB.addOrder(orderData);

            // Save address if new
            const addressData = {
              userId: currentUser.id,
              governorate: window.shippingData.governorate,
              city: window.shippingData.city,
              address: window.shippingData.address,
              postalCode: window.shippingData.postalCode,
              phone: window.shippingData.phone,
              createdAt: new Date().toISOString()
            };

            // Check if address exists using Local Database
            const existingAddresses = await window.localDB.getUserAddresses(currentUser.id);
            const addressExists = existingAddresses.some(addr =>
              addr.address === addressData.address &&
              addr.city === addressData.city
            );

            if (!addressExists) {
              await window.localDB.addAddress(addressData);
            }

            // Clear cart from localStorage
            localStorage.removeItem('cart');

            // Show success
            document.getElementById('orderNumber').textContent = orderNumber;
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            document.getElementById('reviewSection').classList.remove('active');
            document.getElementById('successMessage').classList.add('active');

            showNotification(getTrans('notif-order-success', 'Order placed successfully!'), 'success', getTrans('notif-thank-you', 'Thank You!'));

          } catch (error) {
            console.error('Error placing order:', error);
            showNotification(getTrans('notif-error-order', 'Error placing order: ') + error.message, 'error');
          }
        };
      }
    }
  </script>
  <script src="../JS/db.js"></script>

  <!-- Translation Scripts -->
  <script src="../JS/translations.js"></script>
  <script src="../JS/main.js"></script>
</body>

</html>